#!/usr/bin/env python
'''
OVERVIEW:
Test script for sending UDP commands.
 
AUTHORS:
Bronson Edralin <bedralin@hawaii.edu> and  Isar Mostafanezhad
University of Hawaii at Manoa
Instrumentation Development Lab (IDLab), WAT214
'''


import sys
import os
SCRIPTPATH = os.path.dirname(__file__)
sys.path.append( SCRIPTPATH+'/lib/' )
import linkEth
import time

usageMSG="Usage: pedcalc <interface> <ASIC no>\n This command will calculate the pedestals for the ASIC of interest- will not touch ASIC parameters"
if len(sys.argv)!=3:
	print usageMSG
	exit(-1)

asicNo=int(sys.argv[2]);

if asicNo<0 or asicNo>9 :
	print usageMSG
	exit(-1)


# Ethernet Configuration
addr_fpga = '192.168.20.5'
addr_pc = '192.168.20.1'
port_pc = '28672'
port_fpga = '24576'
interface = sys.argv[1]

# Make UDP class for receiving/sending UDP Packets
ctrl = linkEth.UDP(addr_fpga, port_fpga, addr_pc, port_pc, interface)

cmd_en =hex((int('AF290000',16) | 2**15 | 2**asicNo  )).split('x')[1] #enable ped calc
cmd_dis=hex((int('AF290000',16)         | 2**asicNo  )).split('x')[1] #discable ped calc

ctrl.open()
syncwd="000000010253594e4300000000"

cmd_pre="01234567AE000100AF000000AE000100AF008000AE000100AE008000AE000100"+\
"AE000100AF00FFFFAE000100AE000100AF008000AE000100AF050080AE000100"+\
"AF060140AE000100B00005AAB00205AAB00405AAB00605AAB00805AAB00A05AA";

#wait time between cmd_pedcalc and cmd_post needs to be long enough for navg
navg="7"; 

cmd_pedcalc="AF4D0000AE000100AF140000AE000100AF1E0000AE000100AF320000AE000100"+\
"AF2C0000AE000100AF2D0001AE000100AF2D0000AE000100AF3303FFAE000100"+\
"AF340000AE000100AF350000AE000100AF360000AE000100AF370001AE000100"+\
"AF370000AE000100AF380000AE000100AF390004AE000100AF3A0000AE000100"+\
"AF4803FFAE000100AF3D0F00AE000100AF26000"+navg+"AE000100AF26080"+navg+\
"AE000100AF26000"+navg+"AE000100AF0B8001AE000100AF0A0000AE000100AF0A0001"+\
"AE000100AF0A0000AE000100AF26000"+navg+"AE000100AF26400"+navg+"AE000100"+\
"AF26C00"+navg+"AE000100AF26400"+navg+"AE000100AF270000AE000100AF2AFE00"+\
"AE000100"+cmd_dis+"AE000100"+cmd_en+"AE00FFFFAE00FFFFAE00FFFFAE00FFFF"+\
"AE00FFFFAE00FFFF"+cmd_dis+"AE00FFFFAE00FFFFAE00FFFFAE00FFFFAE00FFFF"+\
"AE00FFFFAE00FFFFAE00FFFFAE00FFFF"


cmd_post="01234567AE000100AF000000AE000100AF008000AE000100AE008000AE000100"+\
"AE000100AF00FFFFAE000100AE000100AF008000AE000100AF050080AE000100"+\
"AF060140AE000100AF140000AE000100AF1E0000AE000100AF1F0000AE000100AF320000AE000100"+\
"AF2C0000AE000100AF2D0001AE000100AF2D0000AE000100AF330100AE000100"+\
"AF340000AE000100AF350000AE000100AF360003AE000100AF370001AE000100"+\
"AF370000AE000100AF380000AE000100AF390004AE000100AF3A0000AE000100"+\
"AF4803FFAE000100AF3D0F00AE000100AF260000AE000100AF260800AE000100"+\
"AF260000AE000100AF261080AE000100AF25C000AE000100AF4B0000AE000100"+\
"AF4C0003AE000100AF270000AE000100AF0B8001AE000100AF0A0000AE000100"+\
"AF0A0001AE000100AF0A0000AE000100AF3E0000AE000100AF460000AE000100"+\
"AF470000AE000100AF470001AE000100AF470000AE000100AF460001AE000100"+\
"AF270000AE000100AF4D0450AE000100AF4DC450AE000100AF008D0EAE000100";

ctrl.send(syncwd+cmd_pre)
time.sleep(.1)
ctrl.send(syncwd+cmd_pedcalc)
#needs to be long enough so that pedcalc can finish, depends on navg
time.sleep(18)
ctrl.send(syncwd+cmd_post)
time.sleep(.1)

ctrl.close()


